#!/bin/bash
#
# Check health of a specified process or service that is defined in server directory
# Change config/config.json parameters to handle the behaviour of daemon

CONFIG_FILE=./config/config.json
SERVICE_DIR=./services
LOG_DIR=./logs
LOG_FILE="${LOG_DIR}"/supervisor.log

CONFIG_PARAMS=(SERVICE_NAME CHECK_INTERVAL BACKOFF_NUM RESTART_ATTEPT_INTERVAL)
FILES=(CONFIG_FILE SERVICE_DIR)

#######################################
# Create log directory and check  
# 	essential directories
# Globals:
#   LOG_DIR
# Arguments:
#   None
# Returns:
#   None
#######################################
function initialization {
	mkdir "${LOG_DIR}" 2>/dev/null
	for file in "${FILES[@]}"; do
		if [[ ! -f "${!file}" ]]; then
			log "${!file} does not exist --> Exit"
			exit
		fi
	done	
}

#######################################
# Fetch config parameters from 
# 	config/config.json
# Globals:
#   CONFIG_PARAMS
#   CONFIG_FILE
# Arguments:
#   None
# Returns:
#   None
#######################################
function fetchConfigs {
	log "|_Fetch configs"
	for param in ${CONFIG_PARAMS[@]}; do
		eval "${param}=$(jq .${param} ${CONFIG_FILE})"
		log "|__>${param} fetched as ${!param}"
	done
}

#######################################
# Logging 
# Globals:
#   LOG_FILE
# Arguments:
#   A Text
# Returns:
#   None
#######################################
function log {
	echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')]: $@" >> ${LOG_FILE}
}

#######################################
# Check whether the service is running 
# 	or not available 
# Globals:
#   serviceName
# Arguments:
#   None
# Returns:
#   None
#######################################
function isAlive {
	pgrep -x ${serviceName} >/dev/null
}

#######################################
# Start the process or service   
# Globals:
#   serviceName
#	SERVICE_DIR
# Arguments:
#   None
# Returns:
#   None
#######################################
function startService {
	nohup "${SERVICE_DIR}/${serviceName}" >/dev/null 2>&1 &
}

#######################################
# Attempt to start the process or service   
# Globals:
#   serviceName
#	SERVICE_DIR
#	backOffNum
#	restartAttemptsInterval
# Arguments:
#   None
# Returns:
#   None
#######################################
function startAttempt {
	log "|_Attempting start the service ${serviceName}"
	for try in $(seq 1 ${backOffNum}); do
		if ! isAlive; then
			log "|__>try ${try} of ${backOffNum} to start ${serviceName}"
			startService	
		else
			break
		fi
		sleep ${restartAttemptsInterval}
	done
	if [[ ${try} -eq ${backOffNum} ]] && ! isAlive;	then
		echo "backoff"
	else
		echo "continue"
	fi
}

#######################################
# Back off trying to start the process   
# Globals:
#   serviceName
#	backOffNum
# Arguments:
#   None
# Returns:
#   None
#######################################
function backOff {
	log "|__>After ${backOffNum} tries ${serviceName} could not be started --> BackOff and Exit"
	exit
}


#######################################
# Main function   
# Globals:
#   serviceName
#	checkInterval
# Arguments:
#   None
# Returns:
#   None
#######################################
function main {
	initialization
	fetchConfigs

	while true; do
		if ! isAlive; then
			log "${serviceName} is not alive --> Attempt to start"
			if [[ "$(startAttempt)" == "backoff" ]]; then
				backOff
			fi		
		else
			log "${serviceName} is alive --> Check again ${checkInterval} seconds later"
		fi
		sleep ${checkInterval}
	done
}

main




